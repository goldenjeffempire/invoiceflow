{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="dashboard-container py-5" data-aos="fade-up">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="fw-bold h2 mb-1">Welcome, {{ user.username }}</h1>
            <p class="text-muted small">Here's what's happening with your business today</p>
        </div>
        <div class="d-flex gap-3">
            <a href="{% url 'invoices:invoice_create' %}" class="btn btn-primary-custom">
                <i class="fa-solid fa-plus small"></i> New Invoice
            </a>
            <a href="{% url 'expenses:expense_create' %}" class="btn btn-secondary-custom">
                <i class="fa-solid fa-receipt small"></i> Add Expense
            </a>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="card-feature p-4 border-0 shadow-sm bg-glass h-100">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="icon-box bg-primary bg-opacity-10 text-primary rounded-3" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa-solid fa-money-bill-trend-up"></i>
                    </div>
                    <span class="fw-bold small text-uppercase text-muted tracking-wider">Revenue</span>
                </div>
                <h3 class="fw-bold mb-1">₦{{ total_sales|floatformat:2 }}</h3>
                <span class="text-success small fw-bold"><i class="fa-solid fa-arrow-trend-up"></i> 12% increase</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-feature p-4 border-0 shadow-sm bg-glass h-100">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="icon-box bg-danger bg-opacity-10 text-danger rounded-3" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa-solid fa-file-invoice-dollar"></i>
                    </div>
                    <span class="fw-bold small text-uppercase text-muted tracking-wider">Expenses</span>
                </div>
                <h3 class="fw-bold mb-1">₦{{ total_expenses|floatformat:2 }}</h3>
                <span class="text-danger small fw-bold"><i class="fa-solid fa-arrow-trend-down"></i> 5% decrease</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-feature p-4 border-0 shadow-sm bg-glass h-100">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="icon-box bg-success bg-opacity-10 text-success rounded-3" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa-solid fa-gem"></i>
                    </div>
                    <span class="fw-bold small text-uppercase text-muted tracking-wider">Net Profit</span>
                </div>
                <h3 class="fw-bold mb-1 {% if net_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                    ₦{{ net_profit|floatformat:2 }}
                </h3>
                <span class="text-success small fw-bold"><i class="fa-solid fa-arrow-trend-up"></i> 8% growth</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-feature p-4 border-0 shadow-sm bg-glass h-100">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="icon-box bg-info bg-opacity-10 text-info rounded-3" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa-solid fa-users"></i>
                    </div>
                    <span class="fw-bold small text-uppercase text-muted tracking-wider">Clients</span>
                </div>
                <h3 class="fw-bold mb-1">{{ clients_count }}</h3>
                <span class="text-muted small fw-bold">Active network</span>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card-feature p-5 border-0 shadow-sm bg-glass h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="fw-bold mb-0">Performance Overview</h4>
                    <span class="badge bg-light text-dark rounded-pill px-3">Last 12 Months</span>
                </div>
                <div style="height: 350px;">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card-feature p-5 border-0 shadow-sm bg-glass h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="fw-bold mb-0">Recent Invoices</h4>
                    <a href="{% url 'invoices:invoices_list' %}" class="text-primary small fw-bold text-decoration-none">View All</a>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <tbody>
                            {% for invoice in recent_invoices %}
                            <tr>
                                <td class="py-3">
                                    <div class="fw-bold text-main">#{{ invoice.id }}</div>
                                    <div class="text-muted small">{{ invoice.client.name }}</div>
                                </td>
                                <td class="py-3 text-end">
                                    <div class="fw-bold">₦{{ invoice.total_amount|floatformat:2 }}</div>
                                    <span class="status-badge {{ invoice.status }} py-0 px-2 rounded-pill fw-bold" style="font-size: 0.65rem;">
                                        {{ invoice.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2" class="text-center py-5">
                                    <p class="text-muted small mb-0">No recent activity</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-glass { background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border) !important; }
    .status-badge.draft { background: rgba(100, 116, 139, 0.1); color: #64748b; }
    .status-badge.paid { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .status-badge.sent { background: rgba(0, 102, 255, 0.1); color: #0066ff; }
    .status-badge.overdue { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
    .tracking-wider { letter-spacing: 0.05em; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('performanceChart').getContext('2d');
        const labels = JSON.parse('{{ chart_labels|safe }}');
        const salesData = JSON.parse('{{ chart_sales|safe }}');
        const expensesData = JSON.parse('{{ chart_expenses|safe }}');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Sales',
                        data: salesData,
                        borderColor: '#0066ff',
                        backgroundColor: 'rgba(0, 102, 255, 0.05)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#0066ff',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2
                    },
                    {
                        label: 'Expenses',
                        data: expensesData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.05)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#ef4444',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#1e293b',
                        bodyColor: '#1e293b',
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        padding: 12,
                        boxPadding: 6,
                        usePointStyle: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                hover: { mode: 'index', intersect: false },
                scales: {
                    y: { 
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.03)', drawBorder: false },
                        ticks: { color: '#94a3b8', font: { size: 11 } }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#94a3b8', font: { size: 11 } }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
{% endblock %}
